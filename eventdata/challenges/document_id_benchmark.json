{% set p_bulk_indexing_clients = (bulk_indexing_clients | default(25)) %}
{% set p_iterations = bulk_indexing_iterations | default(200000) %}
{% set p_iterations_per_client = (p_iterations / p_bulk_indexing_clients) | int %}
{% set p_forcemerge = ( forcemerge | default('no')) | lower %}

{
  "name": "document_id_evaluation",
  "description": "Indexes about 40GB of data into seven single shard indices using different document ID types. IDs are autogenerated by Elasticsearch, meaning there are no conflicts.",
  "meta": {
    "client_count": {{ p_bulk_indexing_clients }},
    "benchmark_type": "document-id-evaluation"
  },
  "schedule": [
    {
      "name": "deleteindex_elasticlogs-warmup",
      "operation": {
        "operation-type": "delete-index",
        "index": "elasticlogs-warmup"
      },
      "include-in-reporting": false
    },
    {
      "name": "create_elasticlogs-warmup",
      "operation": {
        "operation-type": "createindex",
        "index_name": "elasticlogs-warmup",
        "index_template_body": {
          "template": "elasticlogs-warmup",
          "settings": {
            "index.refresh_interval": "5s",
            "index.codec": "best_compression",
            "index.translog.retention.size": "10mb",
            "index.number_of_replicas": 0,
            "index.number_of_shards": 1
          },
          "mappings": "mappings.json",
          "aliases": {}
        },
        "index_template_name": "elasticlogs-warmup"
      },
      "include-in-reporting": false
    },
    {
      "name": "index-append-1000-elasticlogs-warmup",
      "operation": {
        "operation-type": "bulk",
        "param-source": "elasticlogs_bulk",
        "index": "elasticlogs-warmup",
        "bulk-size": 1000,
        "id_type": "auto"
      },
      "iterations": 200,
      "clients": {{ p_bulk_indexing_clients }},
      "include-in-reporting": false
    },
    {
      "name": "deleteindex_elasticlogs-warmup-final",
      "operation": {
        "operation-type": "delete-index",
        "index": "elasticlogs-warmup"
      },
      "include-in-reporting": false
    },
    {% for id in [{ 'type': 'auto', 'desc': 'auto' },
                  { 'type': 'uuid', 'desc': 'uuid' },
                  { 'type': 'sha1',  'desc': 'sha1' },
                  { 'type': 'md5',  'desc': 'md5' },
                  { 'type': 'epoch_uuid',  'desc': 'epoch_uuid' },
                  { 'type': 'epoch_md5',  'desc': 'epoch_md5'} ] %}
    {
      "name": "deleteindex_elasticlogs-{{ id['desc'] }}",
      "operation": {
        "operation-type": "delete-index",
        "index": "elasticlogs-{{ id['desc'] }}"
      },
      "include-in-reporting": false
    },
    {
      "name": "create_elasticlogs-{{ id['desc'] }}",
      "operation": {
        "operation-type": "createindex",
        "index_name": "elasticlogs-{{ id['desc'] }}",
        "index_template_body": {
          "template": "elasticlogs-{{ id['desc'] }}",
          "settings": {
            "index.refresh_interval": "5s",
            "index.codec": "best_compression",
            "index.translog.retention.size": "10mb",
            "index.number_of_replicas": 0,
            "index.number_of_shards": 1
          },
          "mappings": "mappings.json",
          "aliases": {}
        },
        "index_template_name": "elasticlogs-{{ id['desc'] }}"
      },
      "include-in-reporting": false
    },
    {
      "name": "index-append-1000-elasticlogs-{{ id['desc'] }}",
      "operation": {
        "operation-type": "bulk",
        "param-source": "elasticlogs_bulk",
        "index": "elasticlogs-{{ id['desc'] }}",
        "bulk-size": 1000,
        "id_type": "{{ id['type'] }}"
      },
      "iterations": {{ p_iterations_per_client }},
      "clients": {{ p_bulk_indexing_clients }},
      "meta": {
        "id_mode": "{{ id['desc'] }}"
      }
    },
    {
      "name": "indicesstats-elasticlogs-{{ id['desc'] }}",
      "operation": {
        "operation-type": "indicesstats",
        "index_pattern": "elasticlogs-{{ id['desc'] }}"
      },
      "meta": {
        "forcemerged": "no",
        "id_mode": "{{ id['desc'] }}"
      }
    },
    {% if (p_forcemerge != 'no') %}      
    {
      "name": "force-merge-{{ id['desc'] }}",
      "operation": {
        "operation-type": "force-merge",
        "max-num-segments": 1
      },
      "clients": 1
    },
    {  
      "name": "indicesstats-elasticlogs-fm-{{ id['desc'] }}",
      "operation": {
        "operation-type": "indicesstats",
        "index_pattern": "elasticlogs-{{ id['desc'] }}"
      },
      "meta": {
        "forcemerged": "yes",
        "id_mode": "{{ id['desc'] }}"
      }
    },
    {% endif %}
    {% endfor %}
    {% for id in [{ 'type': 'epoch_md5', 'desc': 'epoch_md5-10pct_60s', 'delay': 60 },
                  { 'type': 'epoch_md5', 'desc': 'epoch_md5-10pct_300s', 'delay': 300 }] %}
        {
      "name": "deleteindex_elasticlogs-{{ id['desc'] }}",
      "operation": {
        "operation-type": "delete-index",
        "index": "elasticlogs-{{ id['desc'] }}"
      },
      "include-in-reporting": false
    },
    {
      "name": "create_elasticlogs-{{ id['desc'] }}",
      "operation": {
        "operation-type": "createindex",
        "index_name": "elasticlogs-{{ id['desc'] }}",
        "index_template_body": {
          "template": "elasticlogs-{{ id['desc'] }}",
          "settings": {
            "index.refresh_interval": "5s",
            "index.codec": "best_compression",
            "index.translog.retention.size": "10mb",
            "index.number_of_replicas": 0,
            "index.number_of_shards": 1
          },
          "mappings": "mappings.json",
          "aliases": {}
        },
        "index_template_name": "elasticlogs-{{ id['desc'] }}"
      },
      "include-in-reporting": false
    },
    {
      "name": "index-append-1000-elasticlogs-{{ id['desc'] }}",
      "operation": {
        "operation-type": "bulk",
        "param-source": "elasticlogs_bulk",
        "index": "elasticlogs-{{ id['desc'] }}",
        "bulk-size": 1000,
        "id_type": "{{ id['type'] }}",
        "id_delay_probability": 0.1,
        "id_delay_secs": {{ id['delay'] }}
      },
      "iterations": {{ p_iterations_per_client }},
      "clients": {{ p_bulk_indexing_clients }},
      "meta": {
        "id_mode": "{{ id['desc'] }}"
      }
    },
    {
      "name": "indicesstats-elasticlogs-{{ id['desc'] }}",
      "operation": {
        "operation-type": "indicesstats",
        "index_pattern": "elasticlogs-{{ id['desc'] }}"
      },
      "meta": {
        "forcemerged": "no",
        "id_mode": "{{ id['desc'] }}"
      }
    },
    {% if (p_forcemerge != 'no') %}  
    {
      "name": "force-merge-{{ id['desc'] }}",
      "operation": {
        "operation-type": "force-merge",
        "max-num-segments": 1
      },
      "clients": 1
    },
    {  
      "name": "indicesstats-elasticlogs-fm-{{ id['desc'] }}",
      "operation": {
        "operation-type": "indicesstats",
        "index_pattern": "elasticlogs-{{ id['desc'] }}"
      },
      "meta": {
        "forcemerged": "yes",
        "id_mode": "{{ id['desc'] }}"
      }
    },
    {% endif %}
    {% endfor %}  
    {
      "name": "refresh-final",
      "operation": "refresh", 
      "iterations": 1,
      "clients": 1,
      "include-in-reporting": false
    }
  ]
}
