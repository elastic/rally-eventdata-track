{% set p_bulk_indexing_clients = (bulk_indexing_clients | default(8)) %}
{% set p_iterations = bulk_indexing_iterations | default(2000) %}
{% set p_iterations_per_client = (p_iterations / p_bulk_indexing_clients) | int %}
{% set p_shard_sizing_iterations = (shard_sizing_iterations | default(25)) %}
{% set p_shard_sizing_queries = (shard_sizing_queries | default(20)) %}

{
  "name": "shard-sizing",
  "description": "Indexes sets of 2M events into Elasticsearch, followed by index statistics and simulated Kibana queries. IDs are autogenerated by Elasticsearch, meaning there are no conflicts. This process is repeatedly run until 50M events have been indexed into the shard. This allows query latency to be evaluated as a function of shard size.",
  "meta": {
    "benchmark_type": "shard-sizing"
  },
  "schedule": [
    {
      "operation": "deleteindex_elasticlogs"
    },
    {
      "operation": "delete-index-template"
    },
    {
      "operation": "create-index-template"
    },
    {
      "operation": {
        "operation-type": "create-index",
        "index": "elasticlogs"
      }
    },
    {% for n in range(1, p_shard_sizing_iterations) %}
    {
      "name": "index-append-1000-shard-sizing-iteration-{{n}}",
      "operation": "index-append-1000-shard-sizing",
      "iterations": {{ p_iterations_per_client }},
      "clients": {{ p_bulk_indexing_clients }},
      "meta": {
        "iteration_number": {{ n }}
      }
    },
    {
      "name": "indicesstats_elasticlogs-iteration-{{n}}",
      "operation": "indicesstats_elasticlogs",
      "iterations": 1,
      "meta": {
        "iteration_number": {{ n }}
      }
    },
    {
      "name": "kibana-traffic-shard-sizing-50%-iteration-{{n}}",
      "operation": "kibana-traffic-shard-sizing-50%",
      "iterations": {{ p_shard_sizing_queries }},
      "meta": {
        "iteration_number": {{ n }}
      }
    },
    {
      "name": "kibana-traffic-shard-sizing-90%-iteration-{{n}}",
      "operation": "kibana-traffic-shard-sizing-90%",
      "iterations": {{ p_shard_sizing_queries }},
      "meta": {
        "iteration_number": {{ n }}
      }
    },
    {
      "name": "kibana-content_issues-shard-sizing-50%-iteration-{{n}}",
      "operation": "kibana-content_issues-shard-sizing-50%",
      "iterations": {{ p_shard_sizing_queries }},
      "meta": {
        "iteration_number": {{ n }}
      }
    },
    {
      "name": "kibana-content_issues-shard-sizing-90%-iteration-{{n}}",
      "operation": "kibana-content_issues-shard-sizing-90%",
      "iterations": {{ p_shard_sizing_queries }},
      "meta": {
        "iteration_number": {{ n }}
      }
    },
    {% endfor %}
    {
      "operation": "index-append-1000-shard-sizing",    
      "iterations": {{ p_iterations_per_client }},
      "clients": {{ p_bulk_indexing_clients }},
      "meta": {
        "iteration_number": {{ p_shard_sizing_iterations }}
      }
    },
    {
      "operation": "indicesstats_elasticlogs",
      "iterations": 1,
      "meta": {
        "iteration_number": {{ p_shard_sizing_iterations }}
      }
    },
    {
      "operation": "kibana-traffic-shard-sizing-50%",
      "iterations": {{ p_shard_sizing_queries }},
      "meta": {
        "iteration_number": {{ p_shard_sizing_iterations }}
      }
    },
    {
      "operation": "kibana-traffic-shard-sizing-90%",
      "iterations": {{ p_shard_sizing_queries }},
      "meta": {
        "iteration_number": {{ p_shard_sizing_iterations }}
      }
    },
    {
      "operation": "kibana-content_issues-shard-sizing-50%",
      "iterations": {{ p_shard_sizing_queries }},
      "meta": {
        "iteration_number": {{ p_shard_sizing_iterations }}
      }
    },
    {
      "operation": "kibana-content_issues-shard-sizing-90%",
      "iterations": {{ p_shard_sizing_queries }},
      "meta": {
        "iteration_number": {{ p_shard_sizing_iterations }}
      }
    }
  ]
}
